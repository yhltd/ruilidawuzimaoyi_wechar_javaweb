<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myboot.mapper.XiaoShouDingDanMapper">

    <insert id="xiaoShouAdd" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO xiaoshou_dingdan(bianhao,riqi,kehu, yewuyuan, shoujianren,shoujian_phone,shoujian_dizhi, dianpu,
        xiaoxiang_shuilv, beizhu,shenhe,shenhe_zhuangtai,jiashui_heji,jiage_dengji)
        VALUES (#{bianhao},#{riqi},#{kehu},#{yewuyuan},#{shoujianren},#{shoujianPhone},#{shoujianDizhi},#{dianpu},
        #{xiaoxiangShuilv},#{beizhu},#{shenhe},#{shenheZhuangtai},#{jiashuiHeji},#{jiageDengji})
    </insert>

    <update id="xiaoShouUpd">
        UPDATE xiaoshou_dingdan set bianhao=#{bianhao},riqi=#{riqi},kehu=#{kehu}, yewuyuan=#{yewuyuan}, shoujianren=#{shoujianren},
        shoujian_phone=#{shoujianPhone},shoujian_dizhi=#{shoujianDizhi}, dianpu=#{dianpu}, xiaoxiang_shuilv=#{dianpu},
        beizhu=#{beizhu},shenhe=#{shenhe},shenhe_zhuangtai=#{shenheZhuangtai},jiashui_heji=#{jiashuiHeji},jiage_dengji=#{jiageDengji}
        WHERE id = #{id}
    </update>

    <delete id="deleteXiaoShouById">
        DELETE from xiaoshou_dingdan
        WHERE id = #{id}
    </delete>

    <select id="getAll" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan
        ]]>
    </select>

    <select id="getAllByName" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan where yewuyuan = #{yewuyuan}
        ]]>
    </select>

    <select id="getAllByShenHe" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan where shenhe = #{shenhe}
        ]]>
    </select>

    <select id="queryList" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan
            where riqi >= #{start_date} and riqi <= #{stop_date} and kehu like '%' + #{kehu} + '%' and shenhe_zhuangtai like '%' + #{shenhe_zhuangtai} + '%'
        ]]>
    </select>

    <select id="queryListByName" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan
            where yewuyuan = #{yewuyuan} and riqi >= #{start_date} and riqi <= #{stop_date} and kehu like '%' + #{kehu} + '%' and shenhe_zhuangtai like '%' + #{shenhe_zhuangtai} + '%'
        ]]>
    </select>

    <select id="shenHeList" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan where shenhe = #{name} and shenhe_zhuangtai = '审核中'
        ]]>
    </select>

    <update id="dingDanShenHe">
        UPDATE xiaoshou_dingdan set shenhe_zhuangtai=#{type}
        WHERE id = #{id}
    </update>

    <select id="selectXiaoShouById" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select * from xiaoshou_dingdan
            where id = #{id}
        ]]>
    </select>

    <select id="selectWeiFu" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select id,bianhao,riqi,kehu,dianpu,isnull(jiashui_xiaoji,0) as jiashui_xiaoji,isnull(yifu,0) as yifu,round(isnull(jiashui_xiaoji,0)-isnull(yifu,0),2) as weifu,1 as isselect from(select id,bianhao,riqi,kehu,dianpu,jiashui_xiaoji from xiaoshou_dingdan as xiaoshou left join (select xiaoshou_id,sum(convert(float,isnull(jiashui_xiaoji,0))) as jiashui_xiaoji from xiaoshou_dingdan_item group by xiaoshou_id) as xiaoshou_money on xiaoshou.id = xiaoshou_money.xiaoshou_id) as xiaoshou_dingdan left join (select danju_leixing,danju_bianhao,sum(convert(float,isnull(jizhang_jine,0))) + sum(convert(float,isnull(kedi_shuie,0))) as yifu from shouzhi_mingxi group by danju_leixing,danju_bianhao) as fukuan on xiaoshou_dingdan.bianhao = fukuan.danju_bianhao where round(isnull(jiashui_xiaoji,0)-isnull(yifu,0),2) > 0
        ]]>
    </select>

    <select id="selectMaxDanHao" resultType="com.myboot.pojo.XiaoShouDingDan">
        <![CDATA[
            select convert(float,SUBSTRING(isnull(max(bianhao),'XS000000'),3,6)) + 1 as bianhao from xiaoshou_dingdan
        ]]>
    </select>
</mapper>